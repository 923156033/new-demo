<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Administrator's Control Panel</title>
<#include "../../liger.html"/>
<script language="javascript">
var inter;
var art;
function createProgress() {
	$.post("o_backup_progress.do",{},function(data){
		if(data.tablename!=""){
			$("#progress").html("正在备份表："+data.tablename);
			$(".progress_bar").animate({width:data.percent},100);
			$('.progress_bar').attr("title",data.percent);
		}else{
			$("#progress").html("备份完成！");
			window.clearInterval(inter);
			art.close();
			location.reload();
		}
	},"json");
}

function beginBackup() {
	$.post("o_backup.do",{},function(data){
		if(data.status==1){
			inter=window.setInterval("createProgress()",100);
			art = $.dialog({title:'进度条',content:$('#backprogress').html(),padding:10,lock: true});
		}
	},"json");
}

function delfile(filename,i) {
	jQuery.ligerDialog.confirm('确定删除该备份文件吗?', function (confirm) {
    if (confirm){
	$.post("o_delete.do",{filename:filename},function(data){
		$("#file"+i).remove();
	},"json");
    }
    });
}

function beginRevert(filename){
	$.post("o_revert.do",{filename:filename},function(data){
		alert("还原成功!");
	},"json");
}
</script>
</head>

<body>
<div class="blk c">
	<h2>数据库备份/手动备份</h2>
	<div class="c">
        <table width="100%" border="0" cellspacing="0" cellpadding="0" class="pmsTable">
            <tr>
              <th>ID</th><th>文件名</th><th>备份时间</th><th>大小</th><th>操作</th>
            </tr>
            <#list dbfiles as file>
            <tr id="file${file_index+1}">
              <td class="g_t_c">${file_index+1}</td><td class="g_t_c">${file.filename!}</td><td class="g_t_c">${file.lastModifiedDate?string("yyyy-MM-dd HH:mm:ss")}</td><td class="g_t_c">${file.size!}K</td><td class="g_t_c"><a href="javascript:void(0);" onclick="delfile('${file.filename!}','${file_index+1}')">删除</a>&nbsp;|&nbsp;<a href="javascript:void(0);" onclick="beginRevert('${file.filename!}')">还原</a>&nbsp;|&nbsp;<a href="o_download.do?filename=${file.filename!}">下载</a></td>
            </tr>
            </#list>
            <tr>
              <td colspan="5" class="fbtn">
                <@Perm perm="admin:dbconfig:oexp">
                <input type="button" value="备份" class="l-button" onclick="beginBackup()"/>
                <input type="button" value="取消" class="l-button" onclick="JP.f_cancel()"/>
                </@Perm>
              </td>
            </tr>
        </table>
	</div>
</div>

<div id="backprogress" style="display:none">
	<div class="progress_container"><div class="progress_bar tip" title="0%"></div></div>
	<div id="progress"></div>
</div>
</body>
</html>